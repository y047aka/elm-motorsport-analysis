# Requirements Document

## Project Description (Input)
Motorsport.Widget.CarDetails の中で、選択された任意の2台の車両を比較できるように改修する

## Requirements
### スコープ
- 対象: `Motorsport.Widget.CarDetails` および関連サブウィジェット（Histogram, PositionProgression, LapTimeProgression）。
- 目的: 単一車両の詳細ビューに「比較」機能を追加し、任意の2台を並列に比較できるUI/ロジックを提供する。
- 互換性: 既存の単一表示は不要。後方互換なしで導入する。

### ゴール
- ユーザーが2台の車両を選択し、主要指標（周回、ベスト、ヒストグラム、ポジション推移、ラップタイム推移など）を同一画面で比較できる。
- 2台の指標を視覚的に区別可能（色・凡例・ラベル）。
- モバイル（ハーフモーダル含む）で可読・操作可能。

### ノンゴール
- 3台以上の同時比較。
- 新しい統計量の大規模追加（今ある分析値の再利用に限定）。
- サーバサイドの新API追加（既存データ資源をクライアントで活用）。

### 主要ユースケース
- UC1: Leaderboard から車両Aを選択しCarDetailsを開く→CarDetails内で「比較に追加」→車両Bを検索/選択→比較ビューでA/Bを同時に閲覧。
- UC2: 既にAを表示中に、Leaderboard行の「+比較」アクションからBを追加。
- UC3: 比較ビューでA/Bを入れ替え、またはBを解除して単一表示に戻す。

### データ/入力要件
- 既存の `ViewModel` と `ViewModelItem`、`Analysis` を再利用。
- 比較対象は同一イベント/レースに属する車両に限定。
- CarImages は `Data.Series.carImageUrl_Wec season carNumber` を双方に対して解決する。

### 機能要件（FR）
- FR-01: 比較モードの導線をCarDetailsヘッダに追加（「比較に追加」「2台目を選択」）。
- FR-02: 比較対象が2台揃った場合、以下のブロックを並列または重ね合わせで表示する。
  - Current Lap（現行のラップ情報）
  - Last Lap（直近ラップの比較）
  - Histogram（ラップタイム分布。2系列オーバーレイ）
  - Position Progression（ポジション推移の2系列オーバーレイ）
  - Lap Time Progression（ラップ推移の2系列オーバーレイ）
- FR-03: シリーズごとの色分け/凡例表示（A/B）を必須化。
- FR-04: アラインメント切替を提供（Lap番号基準/経過時間基準）。
- FR-05: 差分表示トグル（例: ベストラップ差、平均ラップ差、ピット回数差などの数値要約）。
- FR-06: A/Bの入れ替え（Swap）とBの除去（Clear）操作。
- FR-07: 単一選択時は従来の単体ビューをそのまま表示（UIが煩雑化しない）。
- FR-08: ハーフモーダル（Route.Wec.Season_.Event_）内で横幅制約時も崩れないグリッド構成。
- FR-09: 無効値はフォールバックして単体表示。

### 非機能要件（NFR）
- NFR-01: パフォーマンス: 2系列オーバーレイでもフレーム落ちを体感させない（60fpsを目標）。
- NFR-02: メモリ: 比較対象は2台まで、必要最小限の配列・系列構築。
- NFR-03: 国際化: 既存の英語UIテキスト規約を踏襲（多言語対応は範囲外）。

### API/公開インターフェース方針
- 次のいずれかの形式で提供（設計段階で確定）。
  - 方式A: 新関数 `viewCompare : Props -> ViewModelItem -> ViewModelItem -> Html msg` を追加。
  - 方式B: 新モジュール `Motorsport.Widget.CarDetails.Compare` を導入し `view : CompareProps -> Html msg` を公開。
- 既存の `Props` を変更し、`Widget.elm` からの再エクスポート方針は設計で決定。

### UI要件（概要）
- ヘッダ: A/Bの車番・チーム・画像を左右に表示。中央に凡例/操作（Swap/Clear）。
- テーブル/カード: Current/Lastの主要値を2列で比較。
- チャート: Histogram・Position・LapTimeは2系列オーバーレイ、軸共有・凡例表示必須。
- モバイル: 1カラム縦積み＋タブ/トグルで指標切替。チャートはパン/ピンチ不要の範囲で見切れない。

### テレメトリ/計測
- 比較開始/解除、Swap、アラインメント切替のイベントをフック可能に（ダミー実装でOK、送信先は未定）。

### エラーハンドリング
- 異なるイベントの車両を比較しようとした場合はガードして警告表示。
- 画像URL未解決時はプレースホルダを表示（現在の実装踏襲）。

### 受け入れ条件（抜粋）
- AC-01: 単体表示は現行と同一の見た目・数値である。
- AC-02: 2台選択時、Current/Last/Histogram/Position/LapTimeの各ブロックが2系列として描画される。
- AC-03: A/BをSwapしても各値・凡例が正しく入れ替わる。
- AC-04: モバイル（ハーフモーダル）でレイアウト崩れが無い。

### リスクと軽減
- チャートオーバーレイの可読性低下 → 色/凡例/ラインスタイルで明確化。
- 型破壊の発生 → 新関数/新モジュール方式で回避。
- パフォーマンス低下 → 既存系列の再利用・遅延計算の検討。
