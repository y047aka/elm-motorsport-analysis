# 実装計画

## 概要
Lap型データ構造のmetaDataパターン統一を実現するためのコード生成指向の実装タスク。各タスクはElmコード生成LLMが実行可能な具体的な指示として設計されている。

## 実装タスク

### 1. 新しいLap型の基盤実装
- [ ] **1.1 新しいLap型とメタデータ型の定義**
  - `package/src/Motorsport/Lap/Types.elm`モジュールを作成
  - 設計書に基づいて新しいLap型、LapMetaData型、TimingData型、SectorData型、PerformanceData型を定義
  - 既存のMotorsport.Duration、Maybe MiniSectorsとの依存関係を設定
  - Car型のMetaDataと同じ命名規則に従う（carNumber: String, driver: String）
  - _要件: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2_

- [ ] **1.2 基本アクセサー関数の実装**
  - `package/src/Motorsport/Lap/Accessors.elm`モジュールを作成
  - getCarNumber, getDriver, getElapsed, getSector1等の互換性アクセサー関数を実装
  - 既存コードとの後方互換性を保つためのヘルパー関数群
  - 設計書の「互換性アクセサー関数」セクションに従って実装
  - _要件: 4.1, 4.4_

### 2. JSONデコーダーシステムの実装
- [ ] **2.1 基本デコーダーコンポーネントの作成**
  - `package/src/Motorsport/Lap/Decoder.elm`モジュールを作成
  - metaDataDecoder, timingDataDecoder, sectorDataDecoder, performanceDataDecoderを実装
  - Json.Decode.Pipelineを使用した段階的デコード構造
  - 型安全なデコード処理の保証
  - _要件: 1.1, 1.4, 3.2_

- [ ] **2.2 新形式デコーダーの実装**
  - 2.1で作成したDecoder.elmに新形式用のnewFormatDecoderを追加
  - 設計書のnewFormatDecoderコード例に基づいて実装
  - metaDataオブジェクトから直接Lap型にマッピング
  - Pipeline.required/optionalパターンを使用
  - _要件: 3.2, 5.1_

- [ ] **2.3 レガシー形式デコーダーの実装**
  - 2.1で作成したDecoder.elmにlegacyFormatDecoderを追加
  - 既存のフラットJSON構造（carNumber, driver等の個別プロパティ）からの変換
  - buildLapFromLegacy変換関数の実装
  - 設計書の詳細なlegacyFormatDecoderコード例に従う
  - _要件: 2.1, 2.2, 2.3, 3.3_

- [ ] **2.4 統一デコーダーと形式自動検出の実装**
  - 2.1で作成したDecoder.elmにメインのlapDecoderを追加
  - Decode.oneOfを使用して新形式→レガシー形式の順で試行
  - 設計書の「統一デコーダー（形式自動検出付き）」に基づく実装
  - 形式検出の自動化と透明な変換処理
  - _要件: 2.4, 3.1, 3.4_

### 3. エラーハンドリングとバリデーション
- [ ] **3.1 カスタムエラー型とエラー処理の実装**
  - `package/src/Motorsport/Lap/Error.elm`モジュールを作成
  - LapDecodeError型（UnknownFormat, MissingRequiredField, InvalidFieldValue, LegacyFormatConversionError）を定義
  - decodeLapWithErrorHandling, mapDecodeError関数を実装
  - 設計書の「デコードエラー処理戦略」セクションに従う
  - _要件: 3.4, 6.4_

- [ ] **3.2 データバリデーション機能の実装**
  - 3.1で作成したError.elmにvalidateLap関数を追加
  - lap番号の正値チェック、carNumberの非空チェック、timing値の非負チェック
  - Result String Lap型で安全なバリデーション
  - 設計書の「データ検証」セクションの検証ルールを実装
  - _要件: 6.1, 6.4_

### 4. 既存システムとの統合
- [ ] **4.1 既存Motorsport.Lapモジュールの更新**
  - `package/src/Motorsport/Lap.elm`の既存のLap型定義を新しい構造に置き換え
  - 1.1で作成したTypes.elmからの型インポート
  - 既存の公開関数（compareAt, completedLapsAt等）を新しいLap型に対応
  - モジュールの公開インターフェースを維持
  - _要件: 1.1, 1.3, 4.3, 5.2_

- [ ] **4.2 互換性レイヤーの統合**
  - 4.1で更新したMotorsport.Lapに1.2で作成したアクセサー関数をインポート
  - 既存コードが新しいLap型を透明に使用できるよう橋渡し機能を追加
  - 段階的移行をサポートする互換性維持機能
  - _要件: 4.1, 4.2, 5.3_

### 5. テスト実装
- [ ] **5.1 デコーダー単体テストの作成**
  - `package/tests/Motorsport/Lap/DecoderTest.elm`モジュールを作成
  - 新形式、レガシー形式両方のデコードテスト
  - 設計書の「ユニットテスト」セクションのテストケースを実装
  - 成功ケース、失敗ケース、エッジケースの網羅
  - _要件: 2.1, 2.2, 3.1, 3.2, 3.3, 6.1_

- [ ] **5.2 アクセサー関数テストの作成**
  - `package/tests/Motorsport/Lap/AccessorsTest.elm`モジュールを作成
  - 1.2で作成したアクセサー関数群の動作確認テスト
  - 既存コードとの互換性確認テスト
  - _要件: 4.1, 4.4_

- [ ] **5.3 既存データ互換性統合テストの作成**
  - `package/tests/Motorsport/Lap/IntegrationTest.elm`モジュールを作成
  - 実際のF1、WEC、FormulaEデータファイルでのデコードテスト
  - 設計書の「統合テスト」セクションに基づく実装
  - 大規模データセットでの動作確認
  - _要件: 2.1, 2.4, 6.1, 6.2_

### 6. パフォーマンス最適化と検証
- [ ] **6.1 パフォーマンステストの実装**
  - `package/tests/Motorsport/Lap/PerformanceTest.elm`モジュールを作成
  - 1000ラップのバッチデコード性能テスト（目標: <1ms/lap）
  - メモリ使用量の測定と既存比較（目標: +5%以内）
  - 設計書の「パフォーマンステスト」セクションの測定項目を実装
  - _要件: 6.1, 6.2, 6.3_

- [ ] **6.2 デバッグとログ機能の実装**
  - 2.1で作成したDecoder.elmにlogDecodeAttempt, lapDecoderWithLogging関数を追加
  - デコード過程の可視化とデバッグサポート
  - 設計書の「ログ出力とデバッグ」セクションに従う実装
  - 開発時の問題特定を支援する機能
  - _要件: 6.4_

### 7. 最終統合と動作検証
- [ ] **7.1 全コンポーネント統合テスト**
  - 1.1〜6.2で実装した全モジュールの統合動作確認
  - 既存のapp/ディレクトリ内のコードとの接続テスト
  - package/src/Motorsport/以下の他モジュールとの互換性確認
  - エンドツーエンドでのデータフロー検証
  - _要件: 1.1, 2.4, 4.1, 4.2, 5.4_

- [ ] **7.2 移行完了確認と最終検証**
  - 既存の全レーシングシリーズ（F1、FormulaE、WEC）でのデータ処理確認
  - パフォーマンス目標（デコード時間、メモリ使用量）の達成確認
  - エラーハンドリングの網羅的テスト
  - 将来拡張性（CLI統合準備）の確認
  - _要件: 2.1, 2.2, 2.3, 2.4, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 6.4_

## 実装順序と依存関係

### フェーズ1: 基盤構築（タスク1.1-1.2）
- 新しい型定義とアクセサー関数
- 他のタスクの前提条件となる基本構造

### フェーズ2: デコーダー実装（タスク2.1-2.4）
- フェーズ1の型定義を使用
- 段階的なデコーダー機能構築

### フェーズ3: エラー処理と検証（タスク3.1-3.2）
- フェーズ2のデコーダーを拡張
- 堅牢性の向上

### フェーズ4: 既存システム統合（タスク4.1-4.2）
- フェーズ1-3の成果物を既存システムに統合
- 後方互換性の実現

### フェーズ5: テスト実装（タスク5.1-5.3）
- フェーズ1-4の全機能のテスト
- 品質保証の確立

### フェーズ6: 最適化と検証（タスク6.1-6.2）
- フェーズ5のテスト結果を元にした最適化
- パフォーマンス目標の達成

### フェーズ7: 最終統合（タスク7.1-7.2）
- 全フェーズの統合と最終検証
- 本番環境への準備完了

## 要件カバレッジマトリックス

| 要件ID | 対応タスク | 検証方法 |
|--------|------------|----------|
| 1.1-1.4 | 1.1, 4.1, 7.1 | 型定義テスト、統合テスト |
| 2.1-2.4 | 2.3, 2.4, 5.1, 7.2 | デコーダーテスト、互換性テスト |
| 3.1-3.4 | 2.1, 2.2, 2.4, 3.1 | エラーハンドリングテスト |
| 4.1-4.4 | 1.2, 4.2, 5.2, 7.1 | アクセサーテスト、統合テスト |
| 5.1-5.4 | 4.1, 7.1, 7.2 | 拡張性テスト、将来対応確認 |
| 6.1-6.4 | 3.2, 6.1, 6.2, 7.2 | パフォーマンステスト、品質確認 |